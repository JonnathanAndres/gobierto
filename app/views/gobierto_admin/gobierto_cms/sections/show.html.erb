<div class="admin_breadcrumb">
  <%= link_to t("gobierto_admin.welcome.index.title"), admin_root_path %> »
  <%= link_to t(".sections"), admin_cms_sections_path %> »
  <%= @section.title %>
</div>

<h1><%= @section.title %></h1>

<div class="m_v_2">
  <div class="admin_tools f_right right">
    <%= link_to '<i class="fa fa-cog"></i> Configuración'.html_safe, edit_admin_cms_section_path(@section), class: 'open_remote_modal' %>
  </div>
  <%= t('.help') %>
</div>

<div class="pure-g">

  <div class="pure-u-1 pure-u-md-1-2 p_h_r_2">

    <div class="section_editor_section_canvas">
      <div class="section_canvas_tools">
        <%= link_to "", id: "collapse", class: "tipsit", title: t('.collapse'), remote: "true" do %>
          <i class="fa fa-compress"></i>
        <% end %>
        <%= link_to "", id: "expand", class: "tipsit", title: t('.expand'), remote: "true" do %>
          <i class="fa fa-expand"></i>
        <% end %>
      </div>

      <div id="tree1"></div>

    </div>

  </div>

  <div class="pure-u-1 pure-u-md-1-2">

    <div class="form_item input_text">
      <label for="name"><%= t('.select_page') %></label>
      <input type="text" placeholder="<%= t('.placeholders.search') %>" name="q" id="pages_search" data-autocomplete="<%= admin_cms_section_pages_path(@section, format: :js) %>" element_id="#pages" />
    </div>

    <h3><%= t('.last_edited_pages') %></h3>

    <div class="activity_feed section_editor">
      <%= render 'pages_filter' %>
    </div>
  </div>
</div>

<script type="text/javascript">
  window.searchClient = {
    client: algoliasearch('<%= Rails.application.secrets.algolia_application_id %>', '<%= Rails.application.secrets.algolia_search_api_key %>'),
    indexes: ["<%= GobiertoCms::Page.search_index_name %>"],
    filters: "site_id:<%= algolia_search_client.site.id %>"
  };

  $(function() {
    var $tree = $('#tree1');
    $.getJSON(
        '/admin/cms/sections/' + <%= params[:id] %> + '/section_items',
        function(data) {
            $('#tree1').tree({
                data: data['section_items'],
                autoOpen: true,
                dragAndDrop: true,
                onDragStop: handle_drag_stop,
                onCreateLi: function(node, $li) {
                    // Append a link to the jqtree-element div.
                    // The link has an url '#node-[id]' and a data property 'node-id'.
                    $li.find('.jqtree-element').append(
                        '<a remote=true href="#node-'+ node.id +'" class="delete"><i class="fa fa-trash-o tipsit" data-node-id="'+
                        node.id +'" title="Eliminar elemento del menú"></i></a>'
                    );
                }
            });
        }
    );

    function handle_drag_stop(node, event) {
      $.ajax({
         url: '/admin/cms/sections/' + <%= params[:id] %> + '/section_items/' + node.id,
         type: 'PUT',
         dataType: 'json',
         data: { tree: $('#tree1').tree('toJson') },
         success:function(data){

         },
         error:function(data){

         }
      });
    }

    // Handle a click on the edit link
    $tree.on(
        'click', '.delete',
        function(e) {
            // Get the id from the 'node-id' data property
            var node_id = $(e.target).data('node-id');

            // Get the node from the tree
            var node = $tree.tree('getNodeById', node_id);

            if (node) {
                // Display the node name
                $tree.tree('removeNode', node);
            }

            $.ajax({
                type: "POST",
                url: '/admin/cms/sections/' + <%= params[:id] %> + '/section_items/' + node_id,
                dataType: "json",
                data: {"_method":"delete"},
                complete: function(){

                }
            });

            return false;
        }
    );
  });

  $(document).ready(function(){
    //defino los elementos que se pueden arrastrar
    $(".draggable").draggable({ revert: true });

    $("#tree1").droppable({
      drop: function( event, ui ) {
        $.ajax({
           url: '/admin/cms/sections/' + <%= params[:id] %> + '/section_items',
           type: 'POST',
           dataType: 'json',
           data: {page_id: ui.draggable.attr("data-id")},
           success:function(data){
             $('#tree1').tree(
               'appendNode',
               {
                   name: ui.draggable.attr("data-title"),
                   id: data.id
               }
             );
           },
           error:function(data){

           }
        });
      }
    });
  })

  function getNum(val) {
     if (isNaN(val)) {
       return 0;
     }
     return val;
   }

   $('#collapse').click(function() {
     var $tree = $('#tree1');
     var tree = $tree.tree('getTree');
     tree.iterate(function(node) {

       if (node.hasChildren()) {
         $tree.tree('closeNode', node, true);
       }
       return false;
     });
   });

   $('#expand').click(function() {
     var $tree = $('#tree1');
     var tree = $tree.tree('getTree');
     tree.iterate(function(node) {

       if (node.hasChildren()) {
         $tree.tree('openNode', node, true);
       }
       return false;
     });
   });
</script>
